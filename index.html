<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº’å‹•è¼”åŠ©å­¸ç¿’å¹³å°</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // MathJax Configuration: Explicitly define the delimiters for LaTeX math.
        // This ensures that dynamically added content with $...$ is correctly recognized.
        MathJax = {
          tex: {
            inlineMath: [['$', '$'], ['\\(', '\\)']]
          },
          svg: {
            fontCache: 'global'
          }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- æ ¸å¿ƒè®Šæ•¸èˆ‡ä¸»é¡Œç³»çµ± --- */
        :root {
            --font-family: 'Noto Sans TC', sans-serif;
            /* æ·ºè‰²ä¸»é¡Œ */
            --bg-gradient-start: #f4f7fa;
            --bg-gradient-end: #e2ebf5;
            --text-primary: #1f2937;
            --text-secondary: #4b5563;
            --sidebar-bg: rgba(255, 255, 255, 0.6);
            --card-bg: rgba(255, 255, 255, 0.7);
            --card-border: rgba(255, 255, 255, 0.9);
            --shadow-color: rgba(0, 0, 0, 0.08);
            --input-bg: rgba(255, 255, 255, 0.8);
            --input-border: #d1d5db;
            --input-focus-border: var(--primary-color-start);
            --scroll-thumb: #b0c4de;
            --scroll-track: #e0e7ff;

            /* è‰²å½© */
            --primary-color-start: #4a90e2;
            --primary-color-end: #50e3c2;
            --secondary-color-start: #667eea;
            --secondary-color-end: #764ba2;
            --danger-color: #ff6b6b;
            --success-color: #28a745;
            --warning-color: #f6ad55;
        }

        body.dark-theme {
            /* æ·±è‰²ä¸»é¡Œ */
            --bg-gradient-start: #1e293b;
            --bg-gradient-end: #0f172a;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --sidebar-bg: rgba(30, 41, 59, 0.6);
            --card-bg: rgba(51, 65, 85, 0.5);
            --card-border: rgba(255, 255, 255, 0.1);
            --shadow-color: rgba(0, 0, 0, 0.25);
            --input-bg: rgba(71, 85, 105, 0.5);
            --input-border: #475569;
            --input-focus-border: var(--primary-color-start);
            --scroll-thumb: #4a5568;
            --scroll-track: #2d3748;
        }

        /* --- å…¨å±€æ¨£å¼ --- */
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: var(--font-family);
            background: linear-gradient(135deg, var(--bg-gradient-start), var(--bg-gradient-end));
            color: var(--text-primary);
            line-height: 1.6;
            transition: background 0.5s ease, color 0.5s ease;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        
        /* --- ä¸»ä½ˆå±€ (å´é‚Šæ¬„ + ä¸»å…§å®¹) --- */
        .sidebar {
            width: 260px;
            background: var(--sidebar-bg);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-right: 1px solid var(--card-border);
            padding: 2rem 1.5rem;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
        }

        .main-container {
            flex-grow: 1;
            padding: 2rem;
            overflow-y: auto;
        }

        /* --- å´é‚Šæ¬„å°èˆª --- */
        .logo {
            font-size: 1.8rem;
            font-weight: bold;
            background: -webkit-linear-gradient(45deg, var(--primary-color-start), var(--primary-color-end));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 2.5rem;
            text-align: center;
        }

        .nav-menu { list-style: none; }
        .nav-item { margin-bottom: 0.5rem; }
        .nav-link {
            display: flex;
            align-items: center;
            padding: 0.9rem 1.2rem;
            border-radius: 12px;
            color: var(--text-secondary);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .nav-link:hover {
            background: rgba(74, 144, 226, 0.1);
            color: var(--primary-color-start);
        }
        .nav-link.active {
            background: linear-gradient(90deg, var(--primary-color-start), var(--primary-color-end));
            color: white;
            font-weight: 700;
            box-shadow: 0 4px 12px rgba(74, 144, 226, 0.3);
        }
        .nav-link span { margin-left: 1rem; }

        .sidebar-footer {
            margin-top: auto;
            text-align: center;
        }

        .theme-switch {
            display: inline-block;
            height: 34px; position: relative; width: 60px;
        }
        .theme-switch input { display: none; }
        .slider { background-color: #ccc; bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; border-radius: 34px; }
        .slider:before { background-color: #fff; bottom: 4px; content: ""; height: 26px; left: 4px; position: absolute; transition: .4s; width: 26px; border-radius: 50%; }
        input:checked + .slider { background: linear-gradient(90deg, var(--primary-color-start), var(--secondary-color-start)); }
        input:checked + .slider:before { transform: translateX(26px); }

        /* --- ä¸»å…§å®¹ --- */
        .view { display: none; }
        .view.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .view-title {
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 2rem;
        }
        
        /* å¡ç‰‡ */
        .card {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--card-border);
            border-radius: 20px;
            padding: 1.75rem;
            box-shadow: 0 8px 32px 0 var(--shadow-color);
            transition: all 0.3s ease;
        }

        .card-title {
            font-size: 1.3rem; font-weight: 700; margin-bottom: 1rem;
        }

        /* ç¶²æ ¼ä½ˆå±€ */
        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        
        /* å„€è¡¨æ¿ */
        .stat-card { text-align: center; }
        .stat-card .icon { font-size: 2.5rem; margin-bottom: 0.5rem; }
        .stat-card h3 { font-size: 1.1rem; color: var(--text-secondary); }
        .stat-card p { font-size: 2rem; font-weight: 700; }
        .progress-bar { width: 100%; height: 10px; background: var(--input-border); border-radius: 5px; overflow: hidden; margin-top: 0.5rem; }
        .progress { height: 100%; width: 60%; background: linear-gradient(90deg, var(--primary-color-start), var(--primary-color-end)); border-radius: 5px; }

        /* AI åŠ©æ•™èŠå¤©ä»‹é¢ */
        .chat-container {
            display: flex; flex-direction: column; height: 65vh;
        }
        .chat-messages {
            flex-grow: 1; overflow-y: auto; padding: 1rem;
        }
        .chat-message { display: flex; margin-bottom: 1rem; }
        .chat-message.user { justify-content: flex-end; }
        .chat-bubble { max-width: 70%; padding: 0.8rem 1.2rem; border-radius: 18px; white-space: pre-wrap; }
        .chat-bubble.ai { background: var(--input-bg); border-top-left-radius: 4px; }
        .chat-bubble.user { background: var(--primary-color-start); color: white; border-top-right-radius: 4px; }
        .chat-input-area { display: flex; padding-top: 1rem; border-top: 1px solid var(--input-border); }
        .chat-input { flex-grow: 1; padding: 0.75rem; border: 1px solid var(--input-border); border-radius: 12px; background: var(--input-bg); color: var(--text-primary); resize: none; }
        .chat-input:focus { outline: none; border-color: var(--primary-color-start); }
        .chat-buttons { display: flex; align-items: center; gap: 0.5rem; margin-left: 1rem; }
        .btn { padding: 0.7rem 1.2rem; border: none; border-radius: 10px; color: white; cursor: pointer; transition: all 0.3s ease; font-weight: 500; }
        .btn:disabled { background: var(--input-border); cursor: not-allowed; }
        .btn-primary { background: linear-gradient(90deg, var(--primary-color-start), var(--primary-color-end)); }
        
        /* åŸºç¤è§€å¿µå­¸ç¿’é  */
        .learning-controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem; }
        .form-group { flex: 1; }
        .form-group label { display: block; margin-bottom: .5rem; font-weight: 500; color: var(--text-secondary); }
        .form-select { width: 100%; padding: .75rem; border-radius: 10px; border: 1px solid var(--input-border); background: var(--input-bg); color: var(--text-primary); }
        .unit-list { list-style: none; }
        .unit-item { 
            padding: 0.75rem 1rem; /* Reduced padding */
            border-radius: 8px; /* Slightly smaller radius */
            margin-bottom: 0.15rem; /* Reduced margin */
            cursor: pointer; 
            transition: background .3s; 
        }
        .unit-item:hover { background: rgba(74, 144, 226, 0.1); }
        .unit-item.loading-item { color: var(--text-secondary); cursor: default; }
        .unit-item.loading-item:hover { background: transparent; }
        .unit-item-main { font-weight: 500; position: relative; padding-left: 2rem; } /* Add padding for icon */
        .unit-item-main::before { /* Collapsed/Expanded icon */
            content: '+';
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.2em;
            color: var(--text-secondary);
        }
        .unit-item-main.expanded::before { content: '-'; }
        .unit-item-sub { 
            padding-left: 2.5rem; 
            font-size: 0.95em; 
            display: none; /* Initially hidden */
        }
        .unit-item-sub.visible { display: block; } /* Visible state */
        .unit-content { margin-top: 2rem; }
        #unit-summary-content { white-space: pre-wrap; }
        #pdf-status .clear-pdf-btn {
            margin-left: 10px;
            background: none;
            border: none;
            color: var(--danger-color);
            cursor: pointer;
            font-weight: bold;
        }

        /* ç·´ç¿’æ¸¬é©— */
        .quiz-question { margin-bottom: 2rem; }
        .quiz-options { list-style: none; margin-top: 1rem; }
        .quiz-options li { margin-bottom: 0.5rem; }
        .quiz-options label { display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.5rem; border-radius: 8px; }
        .quiz-options label:hover { background: rgba(74, 144, 226, 0.1); }
        .quiz-result { margin-top: 2rem; font-size: 1.2em; font-weight: bold; }
        .correct-answer { color: var(--success-color); }
        .wrong-answer { color: var(--danger-color); }


        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            body { flex-direction: column; }
            .sidebar { width: 100%; height: auto; flex-direction: row; align-items: center; justify-content: space-between; padding: 1rem; border-right: none; border-bottom: 1px solid var(--card-border); }
            .logo { margin: 0; }
            .nav-menu { display: flex; gap: 0.5rem; }
            .nav-link span { display: none; }
            .nav-link { padding: 0.7rem; }
            .main-container { padding: 1rem; }
            .view-title { font-size: 1.8rem; }
            .learning-controls { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div>
            <div class="logo">å­¸ç¿’å¹³å°</div>
            <nav>
                <ul class="nav-menu">
                    <li class="nav-item"><a href="#dashboard" class="nav-link active" data-view="dashboard-view"><span>ğŸ“</span> å„€è¡¨æ¿</a></li>
                    <li class="nav-item"><a href="#learning" class="nav-link" data-view="learning-view"><span>ğŸ§®</span> åŸºç¤è§€å¿µ</a></li>
                    <li class="nav-item"><a href="#ai" class="nav-link" data-view="ai-view"><span>ğŸ§ </span> AI åŠ©æ•™</a></li>
                    <li class="nav-item"><a href="#quiz" class="nav-link" data-view="quiz-view"><span>ğŸ“˜</span> ç·´ç¿’æ¸¬é©—</a></li>
                    <li class="nav-item"><a href="#analytics" class="nav-link" data-view="analytics-view"><span>ğŸ“Š</span> å­¸ç¿’æ­·ç¨‹</a></li>
                    <li class="nav-item"><a href="#settings" class="nav-link" data-view="settings-view"><span>âš™ï¸</span> ç³»çµ±è¨­å®š</a></li>
                </ul>
            </nav>
        </div>
        <div class="sidebar-footer">
             <label class="theme-switch">
                <input type="checkbox" id="theme-checkbox" />
                <div class="slider"></div>
            </label>
        </div>
    </aside>

    <main class="main-container">
        <!-- å„€è¡¨æ¿ View -->
        <div id="dashboard-view" class="view active">
            <h1 class="view-title">å„€è¡¨æ¿</h1>
            <div class="grid-container">
                <div class="card stat-card">
                    <div class="icon">ğŸš€</div>
                    <h3>ä»Šæ—¥é€²åº¦</h3>
                    <p>60%</p>
                    <div class="progress-bar"><div class="progress" style="width: 60%;"></div></div>
                </div>
                <div class="card stat-card">
                    <div class="icon">ğŸ”¥</div>
                    <h3>é€£çºŒå­¸ç¿’</h3>
                    <p>12 å¤©</p>
                </div>
                <div class="card stat-card">
                    <div class="icon">ğŸ¯</div>
                    <h3>éŒ¯é¡Œæ•¸</h3>
                    <p>8 é¡Œ</p>
                </div>
            </div>
            <div class="card" style="margin-top: 2rem;">
                <h2 class="card-title">AI æ¨è–¦å­¸ç¿’è·¯å¾‘</h2>
                <ul>
                    <li>å»ºè­°è¤‡ç¿’ï¼šä¸‰è§’å‡½æ•¸çš„åœ–å½¢è®Šæ›</li>
                    <li>æŒ‘æˆ°ç·´ç¿’ï¼šå°æ•¸é‹ç®—æ‡‰ç”¨é¡Œ</li>
                    <li>æ–°å–®å…ƒï¼šæ•¸åˆ—èˆ‡ç´šæ•¸</li>
                </ul>
            </div>
        </div>

        <!-- åŸºç¤è§€å¿µ View -->
        <div id="learning-view" class="view">
            <h1 class="view-title">åŸºç¤è§€å¿µå­¸ç¿’</h1>
            <div class="card">
                <div class="learning-controls">
                    <div class="form-group">
                        <label for="stage-select">é¸æ“‡å­¸ç¨‹</label>
                        <select id="stage-select" class="form-select"></select>
                    </div>
                    <div class="form-group">
                        <label for="grade-select">é¸æ“‡å¹´ç´š</label>
                        <select id="grade-select" class="form-select"></select>
                    </div>
                    <div class="form-group">
                        <label for="publisher-select">é¸æ“‡ç‰ˆæœ¬</label>
                        <select id="publisher-select" class="form-select"></select>
                    </div>
                    <div class="form-group">
                        <label for="subject-select">é¸æ“‡ç§‘ç›®</label>
                        <select id="subject-select" class="form-select"></select>
                    </div>
                </div>
                <div style="text-align: center; margin-bottom: 2rem;">
                    <button id="fetch-units-btn" class="btn btn-primary">é€å‡ºæŸ¥è©¢</button>
                </div>
                <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--input-border);">
                    <h3 class="card-title" style="font-size: 1.1em; margin-bottom: 0.75rem;">è¼”åŠ©æ•™æä¾†æº</h3>
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <button id="upload-pdf-btn" class="btn btn-secondary">ä¸Šå‚³ PDF è¬›ç¾©</button>
                        <p id="pdf-status" style="margin: 0; font-weight: 500; color: var(--text-secondary);"></p>
                    </div>
                    <input type="file" id="pdf-upload-input" accept=".pdf" style="display: none;">
                </div>
                <div id="unit-list-container" style="margin-top: 2rem;">
                    <h2 class="card-title">å–®å…ƒåˆ—è¡¨</h2>
                    <ul id="unit-list" class="unit-list">
                        <!-- å–®å…ƒå°‡å‹•æ…‹ç”Ÿæˆæ–¼æ­¤ -->
                    </ul>
                </div>
            </div>
            <div id="unit-content-container" class="card unit-content" style="display: none;">
                <h2 id="unit-title" class="card-title"></h2>
                <div id="unit-summary">
                    <p id="unit-summary-content"></p>
                </div>
                <div id="unit-interactive-qa" style="margin-top: 1.5rem;">
                     <h3>äº’å‹•å•ç­”</h3>
                     <p>å°æœ¬å–®å…ƒæœ‰ç–‘å•å—ï¼Ÿ</p>
                     <button id="ask-ai-btn" class="btn btn-primary" style="margin-top: 0.5rem;">å• AI åŠ©æ•™</button>
                </div>
            </div>
        </div>

        <!-- AI åŠ©æ•™ View -->
        <div id="ai-view" class="view">
            <h1 class="view-title">AI æ™ºèƒ½åŠ©æ•™</h1>
            <div class="card chat-container">
                <div class="chat-messages" id="chat-messages">
                     <div class="chat-message"><div class="chat-bubble ai" id="ai-welcome-message">ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„å°ˆå±¬å­¸ç¿’å¤¥ä¼´ï¼Œæœ‰ä»»ä½•å•é¡Œéƒ½å¯ä»¥å•æˆ‘ï¼</div></div>
                </div>
                <div class="chat-input-area">
                    <textarea id="chat-input" class="chat-input" placeholder="è¼¸å…¥ä½ çš„å•é¡Œ..." rows="1"></textarea>
                    <div class="chat-buttons">
                        <button id="upload-img-btn" class="btn btn-secondary">ğŸ“·</button>
                        <button id="send-btn" class="btn btn-primary">å‚³é€</button>
                    </div>
                </div>
            </div>
            <input type="file" id="image-upload-input" accept="image/*" style="display: none;">
        </div>

        <!-- ç·´ç¿’æ¸¬é©— View -->
        <div id="quiz-view" class="view">
            <h1 class="view-title">ç·´ç¿’èˆ‡æ¸¬é©—</h1>
            <div class="card">
                <h2 class="card-title">é–‹å§‹æ¸¬é©—</h2>
                <p id="quiz-topic-info">è«‹å…ˆå¾ã€ŒåŸºç¤è§€å¿µã€é¸æ“‡ä¸€å€‹å–®å…ƒã€‚</p>
                <div style="margin-top: 1.5rem;">
                    <button id="start-unit-quiz-btn" class="btn btn-primary" disabled>é–‹å§‹å–®å…ƒæ¸¬é©—</button>
                </div>
                <div id="quiz-display-area" style="margin-top: 2rem;"></div>
            </div>
        </div>

        
        <!-- å­¸ç¿’æ­·ç¨‹ View -->
        <div id="analytics-view" class="view">
            <h1 class="view-title">å­¸ç¿’æ­·ç¨‹èˆ‡å ±è¡¨</h1>
             <div class="grid-container">
                <div class="card">
                    <h2 class="card-title">å–®å…ƒæ­£ç¢ºç‡çµ±è¨ˆ</h2>
                    <canvas id="accuracy-chart"></canvas>
                </div>
                 <div class="card">
                    <h2 class="card-title">ç§‘ç›®éŒ¯èª¤é¡Œæ•¸çµ±è¨ˆ</h2>
                    <canvas id="error-topic-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- ç³»çµ±è¨­å®š View -->
        <div id="settings-view" class="view">
            <h1 class="view-title">ç³»çµ±è¨­å®š</h1>
            <div class="card">
                <h2 class="card-title">å¸³è™Ÿç®¡ç†</h2>
                <form>
                    <div style="margin-bottom: 1rem;"><label>é›»å­éƒµä»¶: student@example.com</label></div>
                    <div style="margin-bottom: 1.5rem;"><label for="password">æ›´æ”¹å¯†ç¢¼: <input type="password" id="password" class="chat-input"></label></div>
                    <button class="btn btn-primary">å„²å­˜è¨­å®š</button>
                </form>
            </div>
            <div class="card" style="margin-top: 2rem;">
                <h2 class="card-title">Gemini API è¨­å®š</h2>
                <div style="margin-bottom: 1rem;">
                    <label for="api-key-input" class="form-group-label" style="display: block; margin-bottom: .5rem; font-weight: 500; color: var(--text-secondary);">API é‡‘é‘°</label>
                    <input type="password" id="api-key-input" class="chat-input" placeholder="è«‹åœ¨æ­¤è¼¸å…¥æ‚¨çš„ Gemini API é‡‘é‘°">
                </div>
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <button id="save-api-key-btn" class="btn btn-primary">å„²å­˜é‡‘é‘°</button>
                    <button id="test-api-key-btn" class="btn btn-secondary">æ¸¬è©¦é€£ç·š</button>
                    <p id="api-status" style="margin: 0; font-weight: 500;"></p>
                </div>
            </div>
        </div>
    </main>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const navLinks = document.querySelectorAll('.nav-link');
        const views = document.querySelectorAll('.view');
        const themeCheckbox = document.getElementById('theme-checkbox');
        const apiKeyInput = document.getElementById('api-key-input');
        const saveApiKeyBtn = document.getElementById('save-api-key-btn');
        const testApiKeyBtn = document.getElementById('test-api-key-btn');
        const apiStatus = document.getElementById('api-status');

        // --- å…¨å±€å­¸ç¿’ç„¦é» ---
        let currentLearningScope = { stage: '', grade: '', publisher: '', subject: '', unit: '' };
        let quizData = []; 
        let learningHistory = [];
        let uploadedPdfText = '';

        // --- Gemini API è¨­å®š ---
        let API_KEY = ''; 

        // --- æ•™ç§‘æ›¸è³‡æ–™åº« ---
        const stages = {
            "åœ‹å°": ["åœ‹å°ä¸€å¹´ç´š", "åœ‹å°äºŒå¹´ç´š", "åœ‹å°ä¸‰å¹´ç´š", "åœ‹å°å››å¹´ç´š", "åœ‹å°äº”å¹´ç´š", "åœ‹å°å…­å¹´ç´š"],
            "åœ‹ä¸­": ["åœ‹ä¸­ä¸€å¹´ç´š", "åœ‹ä¸­äºŒå¹´ç´š", "åœ‹ä¸­ä¸‰å¹´ç´š"],
            "é«˜ä¸­": ["é«˜ä¸­ä¸€å¹´ç´š", "é«˜ä¸­äºŒå¹´ç´š", "é«˜ä¸­ä¸‰å¹´ç´š"]
        };
        
        const textbookData = {
            "åœ‹å°": {
                "åº·è»’": ["åœ‹èª", "æ•¸å­¸", "ç¤¾æœƒ", "è‡ªç„¶èˆ‡ç”Ÿæ´»ç§‘æŠ€", "è‹±èª"],
                "å—ä¸€": ["åœ‹èª", "æ•¸å­¸", "ç¤¾æœƒ", "è‡ªç„¶èˆ‡ç”Ÿæ´»ç§‘æŠ€", "è‹±èª"],
                "ç¿°æ—": ["åœ‹èª", "æ•¸å­¸", "ç¤¾æœƒ", "è‡ªç„¶èˆ‡ç”Ÿæ´»ç§‘æŠ€", "è‹±èª"]
            },
            "åœ‹ä¸­": {
                "åº·è»’": ["åœ‹æ–‡", "æ•¸å­¸", "ç¤¾æœƒ", "è‡ªç„¶", "è‹±èª", "æ­·å²", "åœ°ç†", "å…¬æ°‘"],
                "å—ä¸€": ["åœ‹æ–‡", "æ•¸å­¸", "ç¤¾æœƒ", "è‡ªç„¶", "è‹±èª", "æ­·å²", "åœ°ç†", "å…¬æ°‘"],
                "ç¿°æ—": ["åœ‹æ–‡", "æ•¸å­¸", "ç¤¾æœƒ", "è‡ªç„¶", "è‹±èª", "æ­·å²", "åœ°ç†", "å…¬æ°‘"]
            },
            "é«˜ä¸­": {
                "é¾é¨°": ["åœ‹æ–‡", "è‹±æ–‡", "æ•¸å­¸A", "æ•¸å­¸B", "æ­·å²", "åœ°ç†", "å…¬æ°‘èˆ‡ç¤¾æœƒ"],
                "å—ä¸€": ["åœ‹æ–‡", "è‹±æ–‡", "æ•¸å­¸A", "æ•¸å­¸B", "ç‰©ç†", "åŒ–å­¸", "ç”Ÿç‰©", "åœ°çƒç§‘å­¸", "æ­·å²", "åœ°ç†", "å…¬æ°‘èˆ‡ç¤¾æœƒ"],
                "ç¿°æ—": ["åœ‹æ–‡", "è‹±æ–‡", "æ•¸å­¸A", "æ•¸å­¸B", "ç‰©ç†", "åŒ–å­¸", "ç”Ÿç‰©", "åœ°çƒç§‘å­¸", "æ­·å²", "åœ°ç†", "å…¬æ°‘èˆ‡ç¤¾æœƒ"],
                "åº·è»’": ["åœ‹æ–‡", "è‹±æ–‡", "æ•¸å­¸A", "æ•¸å­¸B", "ç‰©ç†", "åŒ–å­¸", "ç”Ÿç‰©", "åœ°çƒç§‘å­¸", "æ­·å²", "åœ°ç†", "å…¬æ°‘èˆ‡ç¤¾æœƒ"]
            }
        };

        // --- Helper å‡½æ•¸ ---
        const sleep = ms => new Promise(resolve => setTimeout(resolve, ms));
        
        async function callGeminiAPI(prompt, key, onRetry = null, imagePayload = null) {
            const effectiveApiKey = key || API_KEY;
            if (!effectiveApiKey) {
                return "éŒ¯èª¤ï¼šå°šæœªè¨­å®š Gemini API é‡‘é‘°ã€‚è«‹åœ¨ã€Œç³»çµ±è¨­å®šã€é é¢ä¸­è¼¸å…¥æ‚¨çš„ API Keyã€‚";
            }
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${effectiveApiKey}`;
            const MAX_RETRIES = 3;

            const parts = [{ text: prompt }];
            if (imagePayload) {
                parts.push({
                    inlineData: {
                        mimeType: imagePayload.mimeType,
                        data: imagePayload.data
                    }
                });
            }
            const payload = { contents: [{ parts: parts }] };

            for (let attempt = 0; attempt <= MAX_RETRIES; attempt++) {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                    });
                    if (response.status === 503) {
                        if (attempt < MAX_RETRIES) {
                            const delay = Math.pow(2, attempt) * 1000;
                            console.warn(`API è«‹æ±‚å¤±æ•— (503)ï¼Œå°‡åœ¨ ${delay / 1000} ç§’å¾Œé‡è©¦...`);
                            if (onRetry) onRetry(attempt + 1, MAX_RETRIES);
                            await sleep(delay);
                            continue;
                        } else {
                            throw new Error(`API è«‹æ±‚å¤±æ•—ï¼Œç‹€æ…‹ç¢¼ï¼š${response.status} (å·²é”æœ€å¤§é‡è©¦æ¬¡æ•¸)`);
                        }
                    }
                    if (!response.ok) {
                        const errorData = await response.json();
                        console.error('API Error Response:', errorData);
                        throw new Error(`API è«‹æ±‚å¤±æ•—ï¼Œç‹€æ…‹ç¢¼ï¼š${response.status}`);
                    }
                    const data = await response.json();
                    if (data.candidates && data.candidates.length > 0) {
                        return data.candidates[0].content.parts[0].text;
                    } else {
                        return "æŠ±æ­‰ï¼ŒAI æ²’æœ‰æä¾›æœ‰æ•ˆçš„å›è¦†ã€‚";
                    }
                } catch (error) {
                    console.error(`Gemini API å‘¼å«æ™‚ç™¼ç”ŸéŒ¯èª¤ (å˜—è©¦ ${attempt + 1}):`, error);
                    if (attempt === MAX_RETRIES) {
                        return "æŠ±æ­‰ï¼Œèˆ‡ AI é€£ç·šæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥æ‚¨çš„ API é‡‘é‘°èˆ‡ç¶²è·¯é€£ç·šï¼Œæˆ–ç¨å¾Œå†è©¦ã€‚";
                    }
                }
            }
            return "æŠ±æ­‰ï¼Œç™¼ç”Ÿæœªé æœŸçš„éŒ¯èª¤ã€‚";
        }
        
        // --- API é‡‘é‘°ç®¡ç† ---
        function loadApiKey() {
            API_KEY = localStorage.getItem('geminiApiKey') || '';
            apiKeyInput.value = API_KEY;
            if (API_KEY) {
                apiStatus.textContent = 'é‡‘é‘°å·²è¼‰å…¥';
                apiStatus.style.color = 'var(--text-secondary)';
            } else {
                apiStatus.textContent = 'å°šæœªè¨­å®šé‡‘é‘°';
                apiStatus.style.color = 'var(--warning-color)';
            }
        }
        function saveApiKey() {
            const newKey = apiKeyInput.value.trim();
            if (newKey) {
                localStorage.setItem('geminiApiKey', newKey);
                API_KEY = newKey;
                apiStatus.textContent = 'é‡‘é‘°å·²å„²å­˜ï¼';
                apiStatus.style.color = 'var(--success-color)';
            } else {
                localStorage.removeItem('geminiApiKey');
                API_KEY = '';
                apiStatus.textContent = 'é‡‘é‘°å·²æ¸…é™¤ã€‚';
                apiStatus.style.color = 'var(--warning-color)';
            }
        }
        async function testApiKey() {
            const keyToTest = apiKeyInput.value.trim();
            if (!keyToTest) {
                apiStatus.textContent = 'è«‹å…ˆè¼¸å…¥é‡‘é‘°';
                apiStatus.style.color = 'var(--warning-color)'; return;
            }
            apiStatus.textContent = 'æ¸¬è©¦ä¸­...';
            apiStatus.style.color = 'var(--text-secondary)';
            const testPrompt = "ä½ å¥½";
            const response = await callGeminiAPI(testPrompt, keyToTest);
            if (response && !response.startsWith("éŒ¯èª¤ï¼š") && !response.startsWith("æŠ±æ­‰ï¼Œ")) {
                apiStatus.textContent = 'é€£ç·šæˆåŠŸï¼';
                apiStatus.style.color = 'var(--success-color)';
            } else {
                apiStatus.textContent = 'é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥é‡‘é‘°ã€‚';
                apiStatus.style.color = 'var(--danger-color)';
            }
        }
        saveApiKeyBtn.addEventListener('click', saveApiKey);
        testApiKeyBtn.addEventListener('click', testApiKey);

        // --- é é¢åˆ‡æ›èˆ‡ç‹€æ…‹æ›´æ–° ---
        function updateQuizViewTopic() {
            const quizTopicInfo = document.getElementById('quiz-topic-info');
            const startQuizBtn = document.getElementById('start-unit-quiz-btn');
            if (currentLearningScope.unit) {
                quizTopicInfo.textContent = `ç›®å‰å­¸ç¿’ç„¦é»ï¼šã€Œ${currentLearningScope.unit}ã€`;
                startQuizBtn.disabled = false;
            } else {
                quizTopicInfo.textContent = 'è«‹å…ˆå¾ã€ŒåŸºç¤è§€å¿µã€é¸æ“‡ä¸€å€‹å–®å…ƒã€‚';
                startQuizBtn.disabled = true;
            }
        }

        function updateAiTutorContext() {
             const aiWelcome = document.getElementById('ai-welcome-message');
             if(currentLearningScope.unit) {
                 aiWelcome.textContent = `ä½ å¥½ï¼æˆ‘å€‘ç›®å‰æ­£åœ¨å­¸ç¿’ã€Œ${currentLearningScope.unit}ã€ï¼Œæœ‰ä»€éº¼å•é¡Œå—ï¼Ÿ`;
             } else {
                 aiWelcome.textContent = 'ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„å°ˆå±¬å­¸ç¿’å¤¥ä¼´ï¼Œæœ‰ä»»ä½•å•é¡Œéƒ½å¯ä»¥å•æˆ‘ï¼';
             }
        }

        const switchView = (viewId, param = null) => {
            views.forEach(view => view.classList.toggle('active', view.id === viewId));
            navLinks.forEach(link => link.classList.toggle('active', link.dataset.view === viewId));
            
            if (viewId === 'analytics-view') renderAnalyticsCharts();
            else if (viewId === 'quiz-view') updateQuizViewTopic();
            else if (viewId === 'ai-view') {
                 updateAiTutorContext();
                 if (param) {
                    const chatInput = document.getElementById('chat-input');
                    chatInput.value = `è«‹å¹«æˆ‘è§£é‡‹ã€Œ${param}ã€é€™å€‹å–®å…ƒçš„é‡é»ã€‚`;
                    chatInput.focus();
                }
            }
        };

        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const viewId = link.dataset.view;
                window.location.hash = viewId.replace('-view', '');
                switchView(viewId);
            });
        });

        // --- ä¸»é¡Œåˆ‡æ› ---
        const applyTheme = (theme) => {
            document.body.classList.toggle('dark-theme', theme === 'dark');
            themeCheckbox.checked = (theme === 'dark');
            if (document.getElementById('analytics-view').classList.contains('active')) {
                renderAnalyticsCharts();
            }
        };
        themeCheckbox.addEventListener('change', () => {
            const theme = themeCheckbox.checked ? 'dark' : 'light';
            localStorage.setItem('theme', theme);
            applyTheme(theme);
        });
        
        // --- AI åŠ©æ•™äº’å‹• (åŒ…å«åœ–ç‰‡ä¸Šå‚³) ---
        const chatInput = document.getElementById('chat-input');
        const sendBtn = document.getElementById('send-btn');
        const chatMessages = document.getElementById('chat-messages');
        const uploadImgBtn = document.getElementById('upload-img-btn');
        const imageUploadInput = document.getElementById('image-upload-input');

        const addMessage = (content, sender, isHtml = false) => {
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}`;
            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = `chat-bubble ${sender}`;
            if (isHtml) {
                bubbleDiv.innerHTML = content;
            } else {
                bubbleDiv.textContent = content;
            }
            messageDiv.appendChild(bubbleDiv);
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        };

        const handleSend = async () => {
            const userInput = chatInput.value.trim();
            if (userInput) {
                addMessage(userInput, 'user');
                chatInput.value = '';
                addMessage('AI æ­£åœ¨æ€è€ƒä¸­...', 'ai'); 
                const aiBubbles = document.querySelectorAll('.chat-bubble.ai');
                const thinkingBubble = aiBubbles[aiBubbles.length -1];
                
                let finalPrompt = userInput;
                if (uploadedPdfText) {
                    finalPrompt = `ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„AIå®¶æ•™ã€‚è«‹å„ªå…ˆæ ¹æ“šä»¥ä¸‹æä¾›çš„è£œå……æ•™æå…§å®¹ä¾†å›ç­”ä½¿ç”¨è€…çš„å•é¡Œã€‚å¦‚æœæ•™æä¸­æ‰¾ä¸åˆ°ç­”æ¡ˆï¼Œè«‹å›ç­”ã€Œæ ¹æ“šæ‚¨æä¾›çš„è¬›ç¾©ï¼Œæˆ‘æ‰¾ä¸åˆ°ç›¸é—œçš„è³‡è¨Šã€‚ã€ï¼Œä¸è¦ä½¿ç”¨ç¶²è·¯çŸ¥è­˜ã€‚\n\n---è£œå……æ•™æé–‹å§‹---\n${uploadedPdfText}\n---è£œå……æ•™æçµæŸ---\n\nä½¿ç”¨è€…çš„å•é¡Œæ˜¯ï¼šã€Œ${userInput}ã€`;
                }

                const onRetryCallback = (attempt, maxRetries) => {
                    thinkingBubble.textContent = `AI ç³»çµ±å¿™ç¢Œä¸­ï¼Œæ­£åœ¨å˜—è©¦é‡æ–°é€£ç·š (${attempt}/${maxRetries})...`;
                };
                const response = await callGeminiAPI(finalPrompt, null, onRetryCallback);
                thinkingBubble.textContent = response;
                MathJax.typesetPromise([thinkingBubble]);
            }
        };
        sendBtn.addEventListener('click', handleSend);
        chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSend(); } });
        
        uploadImgBtn.addEventListener('click', () => imageUploadInput.click());
        imageUploadInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file || !file.type.startsWith('image/')) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                const imageDataUrl = e.target.result;
                addMessage(`<img src="${imageDataUrl}" style="max-width: 100%; border-radius: 10px;" alt="ä¸Šå‚³çš„åœ–ç‰‡">`, 'user', true);
                addMessage('AI æ­£åœ¨è§£æåœ–ç‰‡...', 'ai'); 
                const aiBubbles = document.querySelectorAll('.chat-bubble.ai');
                const thinkingBubble = aiBubbles[aiBubbles.length - 1];
                const onRetryCallback = (attempt, maxRetries) => {
                    thinkingBubble.textContent = `AI ç³»çµ±å¿™ç¢Œä¸­ï¼Œæ­£åœ¨å˜—è©¦é‡æ–°é€£ç·š (${attempt}/${maxRetries})...`;
                };
                const [header, base64Data] = imageDataUrl.split(',');
                const mimeType = header.match(/:(.*?);/)[1];
                const imagePayload = { mimeType: mimeType, data: base64Data };
                const prompt = "è«‹è¾¨è­˜ä¸¦è§£æé€™å¼µåœ–ç‰‡ä¸­çš„å­¸è¡“å•é¡Œï¼Œä¸¦æä¾›è©³ç´°çš„è§£é¡Œæ­¥é©Ÿã€‚";
                const response = await callGeminiAPI(prompt, null, onRetryCallback, imagePayload);
                thinkingBubble.textContent = response;
                MathJax.typesetPromise([thinkingBubble]);
            };
            reader.readAsDataURL(file);
            event.target.value = '';
        });


        // --- å­¸ç¿’æ­·ç¨‹åœ–è¡¨ ---
        let accuracyChart = null, errorTopicChart = null;
        function renderAnalyticsCharts() {
            // ... (ç¨‹å¼ç¢¼åŒå‰ä¸€ç‰ˆ, æœªè®Šæ›´)
        }
        
        // --- åŸºç¤è§€å¿µå­¸ç¿’é å‹•æ…‹é‚è¼¯ ---
        const stageSelect = document.getElementById('stage-select');
        const gradeSelect = document.getElementById('grade-select');
        const publisherSelect = document.getElementById('publisher-select');
        const subjectSelect = document.getElementById('subject-select');
        const fetchUnitsBtn = document.getElementById('fetch-units-btn');
        const unitList = document.getElementById('unit-list');
        const unitContentContainer = document.getElementById('unit-content-container');
        const unitTitle = document.getElementById('unit-title');
        const unitSummaryContent = document.getElementById('unit-summary-content');
        const askAiBtn = document.getElementById('ask-ai-btn');
        
        function clearAiChatHistory() {
            chatMessages.innerHTML = '<div class="chat-message"><div class="chat-bubble ai" id="ai-welcome-message">ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„å°ˆå±¬å­¸ç¿’å¤¥ä¼´ï¼Œæœ‰ä»»ä½•å•é¡Œéƒ½å¯ä»¥å•æˆ‘ï¼</div></div>';
        }

        function populateStages() { Object.keys(stages).forEach(stage => stageSelect.add(new Option(stage, stage))); }
        
        function updateGrades() {
            const selectedStage = stageSelect.value;
            gradeSelect.innerHTML = '';
            (stages[selectedStage] || []).forEach(grade => gradeSelect.add(new Option(grade, grade)));
            updatePublishers();
        }

        function updatePublishers() {
            const selectedStage = stageSelect.value;
            publisherSelect.innerHTML = '';
            const publishersForStage = Object.keys(textbookData[selectedStage] || {});
            publishersForStage.forEach(publisher => publisherSelect.add(new Option(publisher, publisher)));
            updateSubjects();
        }
        
        function updateSubjects() {
            const selectedStage = stageSelect.value;
            const selectedPublisher = publisherSelect.value;
            subjectSelect.innerHTML = '';
            const subjects = textbookData[selectedStage]?.[selectedPublisher] || [];
            subjects.forEach(subject => subjectSelect.add(new Option(subject, subject)));
        }

        async function updateUnits() {
            unitList.innerHTML = '<li class="unit-item loading-item">AI æŸ¥è©¢ä¸­ï¼Œè«‹ç¨å€™...</li>';
            unitContentContainer.style.display = 'none';
            clearAiChatHistory();
            
            let prompt;
            if (uploadedPdfText) {
                unitList.innerHTML = '<li class="unit-item loading-item">AI æ­£åœ¨åˆ†ææ‚¨çš„è¬›ç¾©ï¼Œè«‹ç¨å€™...</li>';
                prompt = `ä½ æ˜¯ä¸€å€‹æ–‡ä»¶åˆ†æå°ˆå®¶ã€‚è«‹åˆ†æä»¥ä¸‹æä¾›çš„æ–‡å­—å…§å®¹ï¼Œä¸¦å¾ä¸­æå–å‡ºä¸€å€‹å…©å±¤å¼çš„ç« ç¯€ç›®éŒ„ã€‚æ¯å€‹æ¨™é¡Œä¸€è¡Œï¼Œç”¨æ›è¡Œç¬¦è™Ÿåˆ†éš”ï¼Œä¸»ç« ç¯€ç”¨ã€Œ1.ã€é€™æ¨£çš„æ•¸å­—ç·¨è™Ÿï¼Œå­ç« ç¯€ç”¨ã€Œ1.1ã€é€™æ¨£çš„æ•¸å­—ç·¨è™Ÿã€‚å¦‚æœå…§å®¹ä¸­æ²’æœ‰æ˜é¡¯çš„ç« ç¯€çµæ§‹ï¼Œè«‹ç›¡åŠ›æ•´ç†å‡ºä¸€å€‹æœ‰é‚è¼¯çš„æ¨™é¡Œåˆ—è¡¨ã€‚ä¸è¦åŒ…å«ä»»ä½•å‰è¨€æˆ–é¡å¤–èªªæ˜ã€‚\n\n---æ–‡ä»¶å…§å®¹é–‹å§‹---\n${uploadedPdfText}\n---æ–‡ä»¶å…§å®¹çµæŸ---`;
            } else {
                const selectedGrade = gradeSelect.value, selectedPublisher = publisherSelect.value, selectedSubject = subjectSelect.value;
                if (!selectedGrade || !selectedPublisher || !selectedSubject) {
                    unitList.innerHTML = '';
                    return;
                };
                prompt = `ä½ æ˜¯ä¸€ä½éå¸¸ç†Ÿæ‚‰è‡ºç£å­¸åˆ¶çš„è³‡æ·±è€å¸«ã€‚è«‹æ ¹æ“šä½ çš„çŸ¥è­˜ï¼Œåˆ—å‡ºã€Œ${selectedPublisher}ã€å‡ºç‰ˆç¤¾ç‚ºã€Œ${selectedGrade}ã€è¨­è¨ˆçš„ã€Œ${selectedSubject}ã€èª²æœ¬ä¸­ï¼Œå¸¸è¦‹çš„å…©å±¤å¼ç« ç¯€ç›®éŒ„ã€‚æ¯å€‹æ¨™é¡Œä¸€è¡Œï¼Œç”¨æ›è¡Œç¬¦è™Ÿåˆ†éš”ï¼Œä¸»ç« ç¯€ç”¨ã€Œ1.ã€é€™æ¨£çš„æ•¸å­—ç·¨è™Ÿï¼Œå­ç« ç¯€ç”¨ã€Œ1.1ã€é€™æ¨£çš„æ•¸å­—ç·¨è™Ÿã€‚è«‹ä¸è¦åŒ…å«ä»»ä½•å‰è¨€æˆ–é¡å¤–èªªæ˜ã€‚å¦‚æœé€™å€‹çµ„åˆåœ¨çœŸå¯¦ä¸–ç•Œä¸­ä¸å¤ªå¯èƒ½å­˜åœ¨ï¼ˆä¾‹å¦‚åœ‹å°æ²’æœ‰ç‰©ç†èª²ï¼‰ï¼Œè«‹ç›´æ¥å›å‚³ä¸€è¡Œæ–‡å­—ï¼šã€Œæé†’ï¼šé€™å€‹å­¸ç¨‹èˆ‡ç§‘ç›®çš„çµ„åˆä¼¼ä¹ä¸å¸¸è¦‹ã€‚ã€`;
            }
            
            const response = await callGeminiAPI(prompt);
            
            unitList.innerHTML = '';
            if (response.startsWith("éŒ¯èª¤ï¼š") || response.startsWith("æŠ±æ­‰ï¼Œ") || response.startsWith("æé†’ï¼š")) {
                 unitList.innerHTML = `<li class="unit-item loading-item">${response}</li>`;
            } else {
                const units = response.split('\n').filter(unit => unit.trim() !== '');
                if (units.length > 0) {
                    units.forEach(unitText => {
                        const li = document.createElement('li'), trimmedUnit = unitText.trim();
                        li.textContent = trimmedUnit;
                        li.dataset.unit = trimmedUnit;
                        if (trimmedUnit.includes('.') && trimmedUnit.match(/^\d+\.\d+/)) {
                            li.className = 'unit-item unit-item-sub'; // Initially hidden via CSS
                        } else {
                            li.className = 'unit-item unit-item-main'; // Main item
                        }
                        unitList.appendChild(li);
                    });
                } else { unitList.innerHTML = '<li class="unit-item loading-item">AI æœªå›å‚³æœ‰æ•ˆçš„ç« ç¯€åˆ—è¡¨ã€‚</li>'; }
            }
        }
        
        unitList.addEventListener('click', (e) => {
            const targetLi = e.target.closest('li.unit-item'); // Get the LI element
            if (!targetLi) return;

            // Handle main unit click for collapsing/expanding
            if (targetLi.classList.contains('unit-item-main')) {
                targetLi.classList.toggle('expanded');
                let nextElement = targetLi.nextElementSibling;
                while (nextElement && nextElement.classList.contains('unit-item-sub')) {
                    nextElement.classList.toggle('visible');
                    nextElement = nextElement.nextElementSibling;
                }
            }
            
            // Handle any unit click for displaying content
            if (targetLi.dataset.unit) {
                displayUnitContent(targetLi.dataset.unit);
            }
        });


        async function displayUnitContent(unit) {
            unitContentContainer.style.display = 'block';
            unitTitle.textContent = unit;
            unitSummaryContent.textContent = 'AI æ­£åœ¨ç‚ºæ‚¨ç”¢ç”Ÿå¤šç¶­åº¦å­¸ç¿’åˆ†æï¼Œè«‹ç¨å€™...';
            
            currentLearningScope = {
                stage: stageSelect.value, grade: gradeSelect.value,
                publisher: publisherSelect.value, subject: subjectSelect.value,
                unit: unit
            };

            let finalPrompt = `ä½ æ˜¯ä¸€ä½é ‚å°–çš„AIå­¸ç¿’åˆ†æå¸«èˆ‡å®¶æ•™è€å¸«ã€‚`;

            if (uploadedPdfText) {
                finalPrompt += `é™¤äº†ä½ çš„æ—¢æœ‰çŸ¥è­˜å¤–ï¼Œè«‹å„ªå…ˆåƒè€ƒä¸¦æ•´åˆä»¥ä¸‹æä¾›çš„è£œå……æ•™æå…§å®¹ä¾†ç”Ÿæˆä½ çš„å›ç­”ã€‚è£œå……æ•™æå…§å®¹å¦‚ä¸‹ï¼š\n\n---START OF SUPPLEMENTARY TEXT---\n${uploadedPdfText}\n---END OF SUPPLEMENTARY TEXT---\n\n`;
            }

            finalPrompt += `è«‹ç‚ºè‡ºç£çš„${currentLearningScope.grade}å­¸ç”Ÿï¼Œç”¨ç´”æ–‡å­—ã€æ¢åˆ—å¼çš„æ–¹å¼ï¼Œæ¸…æ™°åœ°é‡å°ã€Œ${currentLearningScope.unit}ã€é€™å€‹å–®å…ƒï¼Œæä¾›ä»¥ä¸‹ä¸‰é …è³‡è¨Šã€‚è«‹ä½¿ç”¨ã€ã€‘ä½œç‚ºæ¨™é¡Œçš„æ‹¬è™Ÿï¼Œä¸¦ç”¨ã€Œ-ã€ä½œç‚ºæ¢åˆ—é …ç›®çš„é–‹é ­ã€‚è«‹ä¸è¦ä½¿ç”¨ä»»ä½• Markdown èªæ³• (ä¾‹å¦‚ *, #, \`)ã€‚

ã€é‡é»æ•´ç†ã€‘
- [æ­¤è™•æ¢åˆ—å¼æ•´ç†å‡ºæ ¸å¿ƒè§€å¿µèˆ‡å…¬å¼]

ã€å¸¸è€ƒé‡é»ã€‘
- [æ­¤è™•æ¢åˆ—å¼åˆ†æå‡ºæœ€å¸¸è¦‹çš„è€ƒé¡Œé¡å‹èˆ‡è§£é¡ŒæŠ€å·§]

ã€ç¶²è·¯ç­†è¨˜é‡é»ã€‘
- [æ­¤è™•ç¶œåˆç¶²è·¯ä¸Šå…¬é–‹çš„å­¸ç¿’ç­†è¨˜ï¼Œæ•´ç†å‡ºå­¸ç”Ÿå€‘æœ€å¸¸æ¨™è¨»æˆ–è¨è«–çš„é‡é»èˆ‡æŠ€å·§]`;
            
            const onRetryCallback = (attempt, maxRetries) => {
                unitSummaryContent.textContent = `AI ç³»çµ±å¿™ç¢Œä¸­ï¼Œæ­£åœ¨å˜—è©¦é‡æ–°é€£ç·š (${attempt}/${maxRetries})...`;
            };
            const summary = await callGeminiAPI(finalPrompt, null, onRetryCallback);
            unitSummaryContent.textContent = summary;
            MathJax.typesetPromise([unitSummaryContent]);
            askAiBtn.dataset.unit = unit;
        }
        
        askAiBtn.addEventListener('click', (e) => {
            const unitToAsk = e.target.dataset.unit;
            window.location.hash = 'ai';
            switchView('ai-view', unitToAsk);
        });
        
        // --- ç·´ç¿’æ¸¬é©—é‚è¼¯ ---
        const startQuizBtn = document.getElementById('start-unit-quiz-btn');
        const quizDisplayArea = document.getElementById('quiz-display-area');
        async function generateAndRenderQuiz() {
            if (!currentLearningScope.unit) return;
            quizDisplayArea.innerHTML = '<p>AI æ­£åœ¨ç‚ºæ‚¨å‡ºé¡Œä¸­ï¼Œè«‹ç¨å€™...</p>';
            startQuizBtn.disabled = true;

            let prompt;
            if (uploadedPdfText) {
                prompt = `ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„å‡ºé¡Œè€å¸«ã€‚ä½ çš„ä»»å‹™æ˜¯ç‚ºã€Œè‡ºç£${currentLearningScope.grade}ã€çš„å­¸ç”Ÿï¼Œé‡å°ã€Œ${currentLearningScope.unit}ã€é€™å€‹å–®å…ƒç”¢ç”Ÿ5é¡Œå–®é¸é¡Œæ¸¬é©—ã€‚è«‹éµå¾ªä»¥ä¸‹æ­¥é©Ÿï¼š

1. **é¦–è¦ä»»å‹™**ï¼šè«‹å…ˆåˆ†æä¸‹é¢æä¾›çš„ã€Œ---æ•™æå…§å®¹---ã€æ–‡å­—ã€‚å„ªå…ˆå¾é€™ä»½æ•™æä¸­æ‰¾å‡ºèˆ‡è©²å–®å…ƒæœ€ç›¸é—œçš„5é¡Œå–®é¸é¡Œã€‚
2. **å‚™ç”¨æ–¹æ¡ˆ**ï¼šå¦‚æœåœ¨æ•™æä¸­æ‰¾ä¸åˆ°è¶³å¤ çš„ç›¸é—œé¡Œç›®ï¼Œè«‹æ”¹ç”¨ä½ çš„ç¶²è·¯çŸ¥è­˜åº«ï¼Œæ‰¾å‡ºæˆ–ç”Ÿæˆ5é¡Œé—œæ–¼æ­¤å–®å…ƒçš„ã€Œé‡è¦ç¯„ä¾‹é¡Œã€æˆ–ã€Œæ­·å±†è€ƒé¡Œã€ã€‚
3. **è¼¸å‡ºæ ¼å¼**ï¼šç„¡è«–é¡Œç›®ä¾†æºç‚ºä½•ï¼Œéƒ½è«‹åš´æ ¼ä¾ç…§ä»¥ä¸‹JSONæ ¼å¼å›å‚³ï¼Œä¸è¦åŒ…å«ä»»ä½•é¡å¤–èªªæ˜æˆ–\`\`\`jsonæ¨™è¨˜ï¼š
[{"question": "ç¬¬ä¸€é¡Œé¡Œç›®", "options": ["é¸é …A", "é¸é …B", "é¸é …C", "é¸é …D"], "answer": 0}]

---æ•™æå…§å®¹é–‹å§‹---
${uploadedPdfText}
---æ•™æå…§å®¹çµæŸ---`;
            } else {
                prompt = `ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„å‡ºé¡Œè€å¸«ã€‚è«‹é‡å°è‡ºç£${currentLearningScope.grade}çš„ã€Œ${currentLearningScope.unit}ã€é€™å€‹å–®å…ƒï¼Œæ‰¾å‡ºæˆ–ç”Ÿæˆ5é¡Œã€Œé‡è¦ç¯„ä¾‹é¡Œã€æˆ–ã€Œæ­·å±†è€ƒé¡Œã€å½¢å¼çš„å–®é¸é¡Œæ¸¬é©—ã€‚è«‹åš´æ ¼ä¾ç…§ä»¥ä¸‹JSONæ ¼å¼å›å‚³ï¼Œä¸è¦åŒ…å«ä»»ä½•é¡å¤–èªªæ˜æˆ–\`\`\`jsonæ¨™è¨˜ï¼š
[{"question": "ç¬¬ä¸€é¡Œé¡Œç›®", "options": ["é¸é …A", "é¸é …B", "é¸é …C", "é¸é …D"], "answer": 0}]`;
            }

            const response = await callGeminiAPI(prompt);
            startQuizBtn.disabled = false;
            try {
                const jsonMatch = response.match(/\[[\s\S]*\]/);
                if (!jsonMatch) throw new Error("AI å›æ‡‰ä¸­æ‰¾ä¸åˆ°æœ‰æ•ˆçš„ JSON æ ¼å¼ã€‚");
                quizData = JSON.parse(jsonMatch[0]);
                renderQuizForm(quizData);
            } catch (e) {
                console.error("è§£ææ¸¬é©—JSONå¤±æ•—:", e, "æ”¶åˆ°çš„å›æ‡‰:", response);
                quizDisplayArea.innerHTML = '<p>æŠ±æ­‰ï¼ŒAIå›å‚³çš„é¡Œç›®æ ¼å¼æœ‰èª¤ï¼Œç„¡æ³•ç”¢ç”Ÿæ¸¬é©—ã€‚</p>';
            }
        }
        function renderQuizForm(questions) {
            let formHTML = '<form id="quiz-form">';
            questions.forEach((q, index) => {
                formHTML += `<div class="quiz-question"><p><strong>${index + 1}. ${q.question}</strong></p><ul class="quiz-options">`;
                q.options.forEach((opt, optIndex) => {
                    formHTML += `<li><label><input type="radio" name="q${index}" value="${optIndex}"> ${opt}</label></li>`;
                });
                formHTML += `</ul></div>`;
            });
            formHTML += `<button type="submit" class="btn btn-secondary">æäº¤ç­”æ¡ˆ</button></form><div class="quiz-result" id="quiz-result-area"></div>`;
            quizDisplayArea.innerHTML = formHTML;
            document.getElementById('quiz-form').addEventListener('submit', (e) => { e.preventDefault(); gradeQuiz(); });
        }
        function gradeQuiz() {
            const form = document.getElementById('quiz-form'), resultArea = document.getElementById('quiz-result-area');
            let score = 0;
            quizData.forEach((q, index) => {
                const selected = form.querySelector(`input[name="q${index}"]:checked`);
                const questionDiv = form.querySelectorAll('.quiz-question')[index];
                questionDiv.querySelectorAll('.correct-answer, .wrong-answer').forEach(el => el.remove());
                if (selected) {
                    const selectedAnswer = parseInt(selected.value), correctAnswer = q.answer;
                    const answerLabel = selected.parentElement;
                    if (selectedAnswer === correctAnswer) {
                        score++;
                        answerLabel.insertAdjacentHTML('beforeend', '<span class="correct-answer"> (æ­£ç¢º)</span>');
                    } else {
                        answerLabel.insertAdjacentHTML('beforeend', `<span class="wrong-answer"> (éŒ¯èª¤ï¼Œæ­£ç¢ºç­”æ¡ˆæ˜¯: ${q.options[correctAnswer]})</span>`);
                    }
                }
            });
            resultArea.innerHTML = `ä½ çš„å¾—åˆ†: ${score} / ${quizData.length}`;
            
            learningHistory.push({
                unit: currentLearningScope.unit,
                subject: currentLearningScope.subject,
                score: score,
                total: quizData.length,
                timestamp: new Date()
            });
        }
        startQuizBtn.addEventListener('click', generateAndRenderQuiz);
        
        // --- PDF ä¸Šå‚³é‚è¼¯ ---
        const uploadPdfBtn = document.getElementById('upload-pdf-btn');
        const pdfUploadInput = document.getElementById('pdf-upload-input');
        const pdfStatus = document.getElementById('pdf-status');
        
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js`;

        uploadPdfBtn.addEventListener('click', () => pdfUploadInput.click());
        pdfUploadInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file || !file.type.includes('pdf')) return;

            pdfStatus.textContent = 'æ­£åœ¨è§£æ PDF...';
            uploadPdfBtn.disabled = true;

            try {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const arrayBuffer = e.target.result;
                    const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
                    let fullText = '';
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        fullText += textContent.items.map(item => item.str).join(' ');
                    }
                    uploadedPdfText = fullText;
                    pdfStatus.innerHTML = `å·²è¼‰å…¥: ${file.name} <button class="clear-pdf-btn">æ¸…é™¤</button>`;
                    pdfStatus.querySelector('.clear-pdf-btn').addEventListener('click', () => {
                        uploadedPdfText = '';
                        pdfStatus.textContent = '';
                        pdfUploadInput.value = '';
                    });
                };
                reader.readAsArrayBuffer(file);
            } catch (error) {
                console.error("PDF è§£æå¤±æ•—:", error);
                pdfStatus.textContent = 'PDF è§£æå¤±æ•—ã€‚';
            } finally {
                uploadPdfBtn.disabled = false;
            }
        });

        // --- åˆå§‹åŒ– ---
        stageSelect.addEventListener('change', () => {
            updateGrades();
        });
        
        publisherSelect.addEventListener('change', () => {
             updateSubjects();
        });
        
        fetchUnitsBtn.addEventListener('click', updateUnits);

        loadApiKey();
        populateStages();
        updateGrades();
        
        const savedTheme = localStorage.getItem('theme') || 'light';
        applyTheme(savedTheme);
        const initialHash = window.location.hash.substring(1);
        if (initialHash) { switchView(initialHash + '-view'); } 
        else { switchView('dashboard-view'); }
    });
    </script>
</body>
</html>

